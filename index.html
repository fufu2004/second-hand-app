<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סטייל מתגלגל - קהילת אופנה יד שנייה</title>

    <meta name="theme-color" content="#14b8a6"/>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/fufu2004/second-hand-app/main/ChatGPT%20Image%20Jul%2023%2C%202025%2C%2010_44_20%20AM%20copy.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        body { font-family: 'Assistant', sans-serif; }
        .modal-backdrop, .gallery-backdrop { transition: opacity 0.3s ease; }
        .modal-content, .gallery-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .item-card { animation: fadeIn 0.5s ease-in-out; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .dark .item-card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.4);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .skeleton-loader { background-color: #e2e8f0; border-radius: 0.75rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .dark .skeleton-loader { background-color: #374151; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .thumbnail { cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease; }
        
        .gallery-content { width: 100%; height: 100%; }
        #gallery-panzoom-viewport { cursor: grab; }
        #gallery-panzoom-viewport.is-dragging { cursor: grabbing; }
        #gallery-image {
            max-height: 80vh;
            max-width: 90vw;
            transform-origin: 0 0;
        }

        .view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view.active { display: block; }
        .item-card.sold .main-image-container { opacity: 0.5; }
        .item-card.sold .purchase-btn { background-color: #9ca3af; cursor: not-allowed; pointer-events: none; }
        .sold-stamp { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background-color: rgba(239, 68, 68, 0.8); color: white; padding: 8px 16px; border-radius: 8px; font-size: 1.5rem; font-weight: bold; pointer-events: none; z-index: 10; }
        .favorite-btn.favorited svg { fill: #ef4444; color: #ef4444; }
        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); transition: opacity 0.5s, transform 0.5s; z-index: 100; }
        
        .item-card.promoted {
            border: 2px solid #f59e0b;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }
        .promoted-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #f59e0b;
            color: white;
            padding: 3px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .message-bubble { max-width: 75%; }
        .message-bubble.sent { background-color: #dcf8c6; }
        .dark .message-bubble.sent { background-color: #22511f; }
        .message-bubble.received { background-color: #ffffff; }
        .dark .message-bubble.received { background-color: #374151; }
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 2.5rem; color: #ddd; cursor: pointer; transition: color 0.2s; }
        .dark .star-rating label { color: #4b5563; }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label { color: #f59e0b; }
        .static-stars { color: #f59e0b; }
        #announcement-bar span { transition: opacity 0.5s ease-in-out; }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ef4444;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
        }
        .dark .notification-badge {
             border-color: #1f2937;
        }
        
        #notifications-panel { /* Style for desktop panel */
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 50;
        }
        #notifications-panel-mobile { /* New style for mobile panel */
            display: none;
            position: fixed;
            top: 75px; /* Position below the header */
            left: 50%;
            transform: translateX(-50%);
            width: 90vw;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 50;
        }

        .verified-badge {
            color: #3b82f6; /* blue-500 */
            width: 1.1rem;
            height: 1.1rem;
            display: inline-block;
            margin-right: 4px;
            vertical-align: middle;
        }
        
        @keyframes pulse-bell {
            0% { transform: scale(1); }
            10% { transform: scale(0.9) rotate(-8deg); }
            20% { transform: scale(0.9) rotate(8deg); }
            30% { transform: scale(1.1) rotate(-4deg); }
            40% { transform: scale(1.1) rotate(4deg); }
            50% { transform: scale(1.1) rotate(-2deg); }
            60% { transform: scale(1.1) rotate(2deg); }
            70% { transform: scale(1); }
            100% { transform: scale(1); }
        }
        .bell-animation {
            animation: pulse-bell 2.5s ease-in-out infinite;
            transform-origin: center;
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div id="announcement-bar" class="bg-teal-700 text-white text-sm text-center p-2 relative">
        <span></span>
        <button id="close-announcement" aria-label="סגור הודעה" class="absolute top-1/2 right-4 transform -translate-y-1/2 text-xl font-bold">&times;</button>
    </div>

    <div id="auth-container-mobile" class="sm:hidden p-4 space-y-2">
        <div id="auth-content-mobile"></div>
    </div>

    <div class="container mx-auto p-4 max-w-4xl pb-24">
        
        <header class="bg-gray-100/90 dark:bg-gray-900/90 backdrop-blur-sm sticky top-0 z-40 shadow-sm dark:shadow-gray-800 py-1">
            <div class="container mx-auto px-4 flex justify-between items-center">
                <div id="header-right" class="flex-1 flex justify-start items-center gap-4">
                    <div id="header-right-desktop"></div>
                    <div id="header-right-mobile" class="sm:hidden"></div>
                    <div id="header-right-content"></div>
                </div>

                <div class="flex-1 sm:flex-grow-0 flex justify-center px-2">
                    <div data-action="show-main-view" class="flex items-center gap-2 cursor-pointer">
                        <img src="https://raw.githubusercontent.com/fufu2004/second-hand-app/main/ChatGPT%20Image%20Jul%2023%2C%202025%2C%2010_44_20%20AM%20copy.png" alt="לוגו סטייל מתגלגל" class="h-14 w-14 sm:h-16 sm:w-16 rounded-full flex-shrink-0">
                        <div>
                            <h1 class="text-xl sm:text-3xl font-bold text-teal-700 dark:text-teal-500 whitespace-nowrap">סטייל מתגלגל</h1>
                            <p class="text-gray-500 dark:text-gray-400 text-sm sm:text-base flex items-center whitespace-nowrap">הפריטים הכי שווים בקהילה <span class="blinking-dot"></span> LIVE</p>
                        </div>
                    </div>
                </div>
                
                <div id="header-left" class="flex-1 flex justify-end items-center gap-2 sm:gap-4">
                    <div id="auth-content-desktop" class="hidden sm:flex items-center gap-3"></div>
                    <div id="header-left-mobile" class="sm:hidden flex items-center"></div>
                </div>
            </div>
        </header>
        
        <div id="desktop-actions-bar" class="hidden sm:flex justify-center items-center gap-3 my-4 p-2 bg-white/50 dark:bg-gray-800/50 rounded-lg shadow-sm">
            </div>

        <div id="main-view" class="view active">
             <div class="mt-2 space-y-4">
                <input type="text" id="filter-input" placeholder="חיפוש לפי שם הפריט..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-teal-400 transition">
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    <select id="category-select" class="w-full p-3 border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-teal-400 transition"></select>
                    <select id="condition-select" class="w-full p-3 border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-teal-400 transition">
                        <option value="all">כל המצבים</option>
                        <option value="new-with-tags">חדש עם טיקט</option>
                        <option value="new-without-tags">חדש ללא טיקט</option>
                        <option value="like-new">כמו חדש</option>
                        <option value="good">במצב טוב</option>
                        <option value="used">משומש</option>
                    </select>
                    <input type="text" id="size-filter" placeholder="סינון לפי מידה..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-teal-400 transition">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="brand-filter" placeholder="סינון לפי מותג..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-teal-400 transition">
                    <input type="text" id="location-filter" placeholder="סינון לפי עיר..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-teal-400 transition">
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    <input type="number" id="min-price" placeholder="מחיר מינימום" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-teal-400 transition">
                    <input type="number" id="max-price" placeholder="מחיר מקסימום" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-teal-400 transition">
                    <select id="sort-select" class="w-full p-3 border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-teal-400 transition">
                        <option value="newest">החדש ביותר</option>
                        <option value="price_asc">מחיר: מהנמוך לגבוה</option>
                        <option value="price_desc">מחיר: מהגבוה לנמוך</option>
                    </select>
                </div>
                <button id="favorites-filter-btn" class="w-full flex items-center justify-center gap-2 p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-red-900/20" title="הצג מועדפים">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
                    <span>הצג מועדפים בלבד</span>
                </button>
            </div>

            <main id="items-feed" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6"></main>
            <div id="loading-indicator" class="text-center py-8 hidden">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-teal-500 mx-auto"></div>
                <p class="mt-3 text-sm text-gray-600 dark:text-gray-300">טוען פריטים נוספים...</p>
            </div>
            <div id="empty-state" class="text-center py-16 px-4 hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-200">לא נמצאו פריטים</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">נסה לשנות את תנאי החיפוש.</p>
            </div>
        </div>

        <div id="public-profile-view" class="view"></div>

        <div id="profile-view" class="view">
            <div class="my-6 text-center">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">הפריטים שלי</h2>
                <p class="text-gray-500 dark:text-gray-400">כאן אפשר לראות, לערוך ולנהל את כל הפריטים שהעלית</p>
                <div id="verification-status-container" class="mt-4"></div>
            </div>
            <main id="profile-items-feed" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></main>
        </div>

        <div id="chat-view" class="view"></div>

        <div id="admin-view" class="view">
            <div class="my-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">פאנל ניהול</h2>
                <div id="admin-dashboard-content">
                    </div>
            </div>
        </div>
        </div>

    <button id="open-modal-btn" class="fixed bottom-6 left-6 bg-teal-500 hover:bg-teal-600 text-white rounded-full w-16 h-16 flex items-center justify-center text-3xl shadow-lg transform hover:scale-110 transition-transform z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
    </button>

    <div id="upload-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-md p-4 sm:p-6 transform -translate-y-10 max-h-[90vh] overflow-y-auto">
            <h2 id="upload-modal-title" class="text-xl sm:text-2xl font-bold mb-4 text-teal-800 dark:text-teal-300">העלאת פריט חדש</h2>
            <form id="upload-form"> <input type="hidden" id="editing-item-id" value="">
                <div class="space-y-4">
                    <input type="text" id="item-title" name="title" placeholder="שם הפריט (לדוגמה: שמלת קיץ של זארה)" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-400" required>
                    <textarea id="item-description" name="description" placeholder="תיאור קצר (בד, פרטים מיוחדים, וכו')" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-400" rows="3" required></textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="item-category" name="category" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" required>
                            <option value="" disabled selected>בחרי קטגוריה</option>
                            <option value="pants">מכנסיים</option>
                            <option value="shirts">חולצות</option>
                            <option value="jackets">ג'קטים</option>
                            <option value="dresses">שמלות</option>
                            <option value="skirts">חצאיות</option>
                            <option value="top">טופ</option>
                            <option value="tank-tops">גופיות</option>
                            <option value="blazer">בלייזר</option>
                            <option value="accessories">אקססוריז</option>
                            <option value="general">כללי</option>
                        </select>
                        <select id="item-condition" name="condition" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" required>
                            <option value="" disabled selected>מצב הפריט</option>
                            <option value="new-with-tags">חדש עם טיקט</option>
                            <option value="new-without-tags">חדש ללא טיקט</option>
                            <option value="like-new">כמו חדש</option>
                            <option value="good">במצב טוב</option>
                            <option value="used">משומש</option>
                        </select>
                    </div>
                    <input type="text" id="item-size" name="size" placeholder="מידה (לדוגמה: S, 38, One Size)" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-400">
                    <input type="text" id="item-brand" name="brand" placeholder="מותג (לדוגמה: Nike, Zara)" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-400">
                    <input type="text" id="item-location" name="location" placeholder="מיקום (עיר)" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-400" required>
                    <input type="text" id="item-contact" name="contact" placeholder="פרטי קשר (מספר טלפון, טלגרם...)" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-400" required>
                    <input type="number" id="item-price" name="price" placeholder="מחיר מבוקש (בשקלים)" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-400" required>
                    <div id="affiliate-link-container" class="hidden">
                        <label for="item-affiliate-link" class="block text-sm font-medium text-gray-700 dark:text-gray-300">קישור אפילייט (מנהלים בלבד)</label>
                        <input type="url" id="item-affiliate-link" name="affiliateLink" placeholder="https://example.com/product/123" class="w-full p-2 sm:p-3 border rounded-md focus:ring-2 focus:ring-amber-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-400">
                    </div>
                    <div id="promoted-container" class="hidden items-center">
                        <input id="item-promoted" name="isPromoted" type="checkbox" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded">
                        <label for="item-promoted" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">קדם פריט זה (יוצג בראש העמוד)</label>
                    </div>
                    <div>
                        <label for="item-images" class="block text-sm font-medium text-gray-700 dark:text-gray-300">העלאת תמונות (עד 6)</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">בעריכת פריט, השאר שדה זה ריק כדי לשמור את התמונות הקיימות.</p>
                        <input type="file" id="item-images" name="images" class="mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 dark:file:bg-gray-700 dark:file:text-teal-300 dark:hover:file:bg-gray-600" accept="image/*" multiple>
                        <div id="image-preview-container" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" class="close-modal-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-md transition">ביטול</button>
                    <button type="submit" id="submit-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-md transition">פרסמי עכשיו!</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="gallery-modal" class="gallery-backdrop fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="gallery-content relative flex items-center justify-center">
            <div id="gallery-panzoom-viewport" class="w-full h-full">
                <img id="gallery-image" src="" alt="תצוגה מקדימה של הפריט" class="rounded-lg shadow-2xl">
            </div>
        </div>
        
        <div class="absolute top-4 right-4 flex gap-2">
            <button id="gallery-zoom-in" class="bg-white/80 text-gray-800 rounded-full h-10 w-10 flex items-center justify-center text-2xl font-bold shadow-lg hover:bg-white transition" title="זום אין">+</button>
            <button id="gallery-zoom-out" class="bg-white/80 text-gray-800 rounded-full h-10 w-10 flex items-center justify-center text-2xl font-bold shadow-lg hover:bg-white transition" title="זום אאוט">-</button>
            <button id="gallery-close" class="bg-white/80 text-gray-800 rounded-full h-10 w-10 flex items-center justify-center text-2xl font-bold shadow-lg hover:bg-white transition" title="סגור">&times;</button>
        </div>
        <button id="gallery-prev" class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-white/80 text-gray-800 rounded-full h-12 w-12 flex items-center justify-center text-2xl shadow-lg hover:bg-white transition disabled:opacity-50 disabled:cursor-not-allowed" title="הקודם">&#x276E;</button>
        <button id="gallery-next" class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-white/80 text-gray-800 rounded-full h-12 w-12 flex items-center justify-center text-2xl shadow-lg hover:bg-white transition disabled:opacity-50 disabled:cursor-not-allowed" title="הבא">&#x276F;</button>
        <div id="gallery-counter" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white text-sm py-1 px-3 rounded-full"></div>
    </div>

    <div id="custom-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-60"> <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-sm p-4 sm:p-6 transform opacity-0 -translate-y-10"> <h3 id="custom-modal-title" class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4"></h3> <p id="custom-modal-message" class="text-gray-600 dark:text-gray-300 mb-6"></p> <div id="custom-modal-buttons" class="flex justify-end gap-3"></div> </div> </div>
    <div id="share-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-60">
        <div class="modal-content relative bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-xs p-6 transform opacity-0 -translate-y-10">
            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 text-center">שתפי את האפליקציה</h3>
            <div class="space-y-3">
                <a id="whatsapp-share-link" target="_blank" class="flex items-center justify-center gap-3 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.523.074-.797.347-.272.272-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    <span>שתפי בווטסאפ</span>
                </a>
                <button id="copy-link-btn" class="flex items-center justify-center gap-3 w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    <span>העתקת קישור</span>
                </button>
            </div>
            <button type="button" class="close-modal-btn absolute top-2 right-2 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
        </div>
    </div>
    
    <div id="rating-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-60">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-sm p-6 transform -translate-y-10">
            <h2 id="rating-modal-title" class="text-xl font-bold mb-4 text-center text-teal-800 dark:text-teal-300">דרג את המוכר</h2>
            <form id="rating-form">
                <input type="hidden" id="rated-user-id">
                <div class="star-rating mb-4">
                    <input type="radio" id="star5" name="rating" value="5" required/><label for="star5" title="5 כוכבים">&#9733;</label>
                    <input type="radio" id="star4" name="rating" value="4" required/><label for="star4" title="4 כוכבים">&#9733;</label>
                    <input type="radio" id="star3" name="rating" value="3" required/><label for="star3" title="3 כוכבים">&#9733;</label>
                    <input type="radio" id="star2" name="rating" value="2" required/><label for="star2" title="2 כוכבים">&#9733;</label>
                    <input type="radio" id="star1" name="rating" value="1" required/><label for="star1" title="כוכב 1">&#9733;</label>
                </div>
                <textarea id="rating-comment" placeholder="ספר/י על חווית הקנייה... (אופציונלי)" class="w-full p-3 border rounded-md focus:ring-2 focus:ring-teal-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-400" rows="3"></textarea>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" class="close-modal-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-md transition">ביטול</button>
                    <button type="submit" id="submit-rating-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-md transition">שלח דירוג</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="report-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-60">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-md p-6 transform -translate-y-10">
            <h2 class="text-xl font-bold mb-4 text-center text-red-700 dark:text-red-400">דיווח על פריט</h2>
            <form id="report-form">
                <input type="hidden" id="reported-item-id">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">מדוע ברצונך לדווח על פריט זה?</p>
                <div class="space-y-3">
                    <select id="report-reason" name="reason" class="w-full p-3 border rounded-md focus:ring-2 focus:ring-red-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" required>
                        <option value="" disabled selected>בחירת סיבה...</option>
                        <option value="inappropriate-content">תוכן לא הולם (עירום, אלימות וכו')</option>
                        <option value="spam">ספאם או פרסומת</option>
                        <option value="scam">חשד להונאה או פריט מזויף</option>
                        <option value="wrong-category">קטגוריה שגויה</option>
                    </select>
                    <textarea id="report-details" name="details" placeholder="פרטים נוספים (אופציונלי)" class="w-full p-3 border rounded-md focus:ring-2 focus:ring-red-400 transition bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" rows="3"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" class="close-modal-btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-md transition">ביטול</button>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition">שלח דיווח</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-notification" class="toast-notification hidden bg-gray-800 text-white text-sm py-2 px-4 rounded-full"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- Configuration ---
        const SERVER_URL = 'https://second-hand-app-j1t7.onrender.com';
        const ADMIN_EMAIL = 'ohadf1976@gmail.com'; 
        const CLIENT_URL = window.location.origin;

        // --- UI Element Selectors ---
        const mainView = document.getElementById('main-view');
        const profileView = document.getElementById('profile-view');
        const publicProfileView = document.getElementById('public-profile-view');
        const itemsFeed = document.getElementById('items-feed');
        const profileItemsFeed = document.getElementById('profile-items-feed');
        const headerRightDesktop = document.getElementById('header-right-desktop');
        const headerRightMobile = document.getElementById('header-right-mobile');
        const headerRightContent = document.getElementById('header-right-content');
        const headerLeftDesktop = document.getElementById('header-left-desktop');
        const headerLeftMobile = document.getElementById('header-left-mobile');
        const authContentDesktop = document.getElementById('auth-content-desktop');
        const authContainerMobile = document.getElementById('auth-container-mobile');
        const authContentMobile = document.getElementById('auth-content-mobile');
        const openModalBtn = document.getElementById('open-modal-btn');
        const filterInput = document.getElementById('filter-input');
        const categorySelect = document.getElementById('category-select');
        const sortSelect = document.getElementById('sort-select');
        const minPriceInput = document.getElementById('min-price');
        const maxPriceInput = document.getElementById('max-price');
        const favoritesFilterBtn = document.getElementById('favorites-filter-btn');
        const emptyState = document.getElementById('empty-state');
        const chatView = document.getElementById('chat-view');
        const conditionSelect = document.getElementById('condition-select');
        const sizeFilterInput = document.getElementById('size-filter');
        const loadingIndicator = document.getElementById('loading-indicator');
        const brandFilterInput = document.getElementById('brand-filter');
        const locationFilterInput = document.getElementById('location-filter');
        const verificationStatusContainer = document.getElementById('verification-status-container');
        
        // --- Modals & Forms Selectors ---
        const allModals = document.querySelectorAll('.modal-backdrop, .gallery-backdrop');
        const uploadModal = document.getElementById('upload-modal');
        const galleryModal = document.getElementById('gallery-modal');
        const customModal = document.getElementById('custom-modal');
        const shareModal = document.getElementById('share-modal');
        const ratingModal = document.getElementById('rating-modal');
        const reportModal = document.getElementById('report-modal'); 
        const uploadForm = document.getElementById('upload-form');
        const ratingForm = document.getElementById('rating-form');
        const reportForm = document.getElementById('report-form'); 
        const uploadModalTitle = document.getElementById('upload-modal-title');
        const editingItemIdInput = document.getElementById('editing-item-id');
        
        // --- Gallery Elements Selectors ---
        const galleryImage = document.getElementById('gallery-image');
        const galleryClose = document.getElementById('gallery-close');
        const galleryPrev = document.getElementById('gallery-prev');
        const galleryNext = document.getElementById('gallery-next');
        const galleryCounter = document.getElementById('gallery-counter');
        const galleryPanzoomViewport = document.getElementById('gallery-panzoom-viewport');
        const galleryZoomInBtn = document.getElementById('gallery-zoom-in');
        const galleryZoomOutBtn = document.getElementById('gallery-zoom-out');
        
        const toastNotification = document.getElementById('toast-notification');

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            const swUrl = `/sw.js`;
            navigator.serviceWorker.register(swUrl).then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, err => {
              console.log('ServiceWorker registration failed: ', err);
            });
          });
        }

        // --- PWA Custom Install Prompt ---
        let deferredPrompt;
        const installButtonContainerDesktop = document.getElementById('header-right-desktop');
        const installButtonContainerMobile = document.getElementById('auth-container-mobile');

        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          showInstallPromotion();
        });

        function showInstallPromotion() {
            const installButtonHtml = `
                <button id="install-pwa-btn" class="flex items-center gap-2 bg-teal-500 text-white font-semibold py-2 px-3 text-sm rounded-md shadow-sm hover:bg-teal-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    <span>התקנת אפליקציה</span>
                </button>
            `;
            
            if (installButtonContainerDesktop) {
                const desktopBtnWrapper = document.createElement('div');
                desktopBtnWrapper.innerHTML = installButtonHtml;
                installButtonContainerDesktop.prepend(desktopBtnWrapper.firstChild);
            }

            if (installButtonContainerMobile) {
                const mobileBtnWrapper = document.createElement('div');
                mobileBtnWrapper.innerHTML = installButtonHtml.replace('id="install-pwa-btn"', 'id="install-pwa-btn-mobile"');
                mobileBtnWrapper.classList.add('w-full', 'px-4', 'mb-2');
                installButtonContainerMobile.prepend(mobileBtnWrapper);
            }

            document.querySelectorAll('[id^="install-pwa-btn"]').forEach(btn => {
                btn.addEventListener('click', handleInstallClick);
            });
        }

        async function handleInstallClick() {
            document.querySelectorAll('[id^="install-pwa-btn"]').forEach(btn => btn.parentElement.remove());
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
        }

        window.addEventListener('appinstalled', () => {
          deferredPrompt = null;
          console.log('PWA was installed');
        });

        // --- Global State ---
        let socket;
        let currentUser = null;
        let allItemsCache = {}; 
        let galleryImages = [];
        let currentImageIndex = 0;
        let favorites = []; 
        let currentConversationId = null;
        let currentConversationDetails = null;
        let notificationsCache = [];
        let panzoomInstance = null;
        let currentUserProfile = null; 
        let pushSubscription = null; 

        // --- Infinite Scroll State ---
        let currentPage = 1;
        let isLoading = false;
        let hasMorePages = true;

        // --- Category Mapping ---
        const categoryMap = { 
            'pants': 'מכנסיים', 
            'shirts': 'חולצות', 
            'jackets': 'ג\'קטים', 
            'dresses': 'שמלות', 
            'skirts': 'חצאיות', 
            'top': 'טופ', 
            'tank-tops': 'גופיות', 
            'blazer': 'בלייזר', 
            'accessories': 'אקססוריז', 
            'general': 'כללי' 
        };
        
        function initializeSocket(token) {
            if (socket) {
                socket.disconnect();
            }
            
            socket = io(SERVER_URL, {
                auth: { token: token }
            });

            socket.off('connect');
            socket.off('newItem');
            socket.off('itemDeleted');
            socket.off('itemUpdated');
            socket.off('newMessage');
            socket.off('newConversation');
            socket.off('newNotification');

            socket.on('connect', () => {
                console.log('Connected to server with socket ID:', socket.id);
            });

            socket.on('newItem', (item) => { 
                if (filterInput.value === '' && categorySelect.value === 'all' && conditionSelect.value === 'all' && sizeFilterInput.value === '' && minPriceInput.value === '' && maxPriceInput.value === '') {
                    displayItem(item, true, itemsFeed);
                } else {
                    showToast("פריט חדש עלה! נקה סינונים כדי לראות.");
                }
            });
            socket.on('itemDeleted', (itemId) => { 
                const itemElement = document.getElementById(`item-${itemId}`);
                if (itemElement) itemElement.remove();
                const itemElementProfile = profileItemsFeed.querySelector(`#item-${itemId}`); 
                if (itemElementProfile) itemElementProfile.remove(); 
            });
            socket.on('itemUpdated', (updatedItem) => { 
                const card = document.getElementById(`item-${updatedItem._id}`);
                if(card) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = createItemCard(updatedItem);
                    card.replaceWith(tempDiv.firstChild);
                }
                const profileFeedCard = document.querySelector(`#profile-items-feed #item-${updatedItem._id}`); 
                if (profileFeedCard) { 
                    const tempDiv = document.createElement('div'); 
                    tempDiv.innerHTML = createItemCard(updatedItem); 
                    profileFeedCard.replaceWith(tempDiv.firstChild.cloneNode(true)); 
                } 
            });
            
            socket.on('newMessage', (message) => {
                if (chatView.classList.contains('active') && message.conversation === currentConversationId) {
                    appendMessage(message);
                }
            });

            socket.on('newConversation', (data) => {
                showToast(`שיחה חדשה התחילה עם ${data.buyerName} לגבי "${data.itemName}"`);
            });

            socket.on('newNotification', (notification) => {
                notificationsCache.unshift(notification);
                updateNotificationBell();
                showToast(notification.message);
            });
        }
        
        // --- Custom Modal System ---
        let modalResolver;
        function showCustomModal({ title, message, buttons }) {
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').innerHTML = message; 
            const buttonsContainer = document.getElementById('custom-modal-buttons');
            buttonsContainer.innerHTML = '';
            buttons.forEach(btn => {
                const buttonEl = document.createElement('button');
                buttonEl.textContent = btn.text;
                buttonEl.className = btn.class;
                buttonEl.onclick = () => {
                    hideAllModals();
                    if (modalResolver) modalResolver(btn.resolves);
                };
                buttonsContainer.appendChild(buttonEl);
            });
            showModal(customModal);
            return new Promise(resolve => { modalResolver = resolve; });
        }
        
        async function showAlert(message, title = 'הודעה') {
            await showCustomModal({
                title: title,
                message: message,
                buttons: [{ text: 'הבנתי', class: 'bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-md transition', resolves: true }]
            });
        }
        
        function showToast(message) {
            toastNotification.textContent = message;
            toastNotification.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                toastNotification.classList.add('opacity-0');
                setTimeout(() => {
                    toastNotification.classList.add('hidden');
                }, 2500);
            }, 2500);
        }

        // --- View & Modal Management ---
        function showView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); window.scrollTo(0, 0); }
        function hideAllModals() { allModals.forEach(modal => { modal.classList.add('opacity-0'); const content = modal.querySelector('.modal-content, .gallery-content'); if (content) { content.classList.add('opacity-0', '-translate-y-10'); } setTimeout(() => { modal.classList.add('hidden'); }, 300); }); }
        function showModal(modalElement) { allModals.forEach(modal => { if (modal !== modalElement) { modal.classList.add('hidden', 'opacity-0'); } }); modalElement.classList.remove('hidden'); setTimeout(() => { modalElement.classList.remove('opacity-0'); const content = modalElement.querySelector('.modal-content, .gallery-content'); if (content) { content.classList.remove('opacity-0', '-translate-y-10'); } }, 10); }
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', hideAllModals));
        allModals.forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) hideAllModals(); }));

        // --- START: UPDATED Gallery (Lightbox) System with Panzoom ---
        function openGallery(images, startIndex = 0) {
            if (!images || images.length === 0) return;
            galleryImages = images;
            showModal(galleryModal);
            document.body.style.overflow = 'hidden';
            
            panzoomInstance = Panzoom(galleryImage, {
                maxScale: 4,
                minScale: 1,
                canvas: true,
                startScale: 1,
            });
            
            galleryPanzoomViewport.addEventListener('wheel', panzoomInstance.zoomWithWheel);
            
            updateGalleryImage(startIndex);
        }

        function closeGallery() {
            hideAllModals();
            document.body.style.overflow = '';
            if (panzoomInstance) {
                galleryPanzoomViewport.removeEventListener('wheel', panzoomInstance.zoomWithWheel);
                panzoomInstance.destroy();
                panzoomInstance = null;
            }
        }

        function updateGalleryImage(index) {
            currentImageIndex = index;
            if (panzoomInstance) {
                panzoomInstance.reset();
            }
            galleryImage.src = galleryImages[index];
            galleryCounter.textContent = `${index + 1} / ${galleryImages.length}`;
            galleryPrev.disabled = index === 0;
            galleryNext.disabled = index === galleryImages.length - 1;
        }

        galleryPrev.addEventListener('click', () => { if (currentImageIndex > 0) updateGalleryImage(currentImageIndex - 1); });
        galleryNext.addEventListener('click', () => { if (currentImageIndex < galleryImages.length - 1) updateGalleryImage(currentImageIndex + 1); });
        galleryClose.addEventListener('click', closeGallery);
        galleryZoomInBtn.addEventListener('click', () => panzoomInstance?.zoomIn());
        galleryZoomOutBtn.addEventListener('click', () => panzoomInstance?.zoomOut());
        
        document.addEventListener('keydown', (e) => { 
            if (galleryModal.classList.contains('hidden')) return; 
            if (e.key === 'Escape') closeGallery(); 
            if (e.key === 'ArrowRight') galleryNext.click(); 
            if (e.key === 'ArrowLeft') galleryPrev.click(); 
        });
        // --- END: UPDATED Gallery System ---

        function parseJwt (token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Invalid token:", e);
                return null;
            }
        }
        
        // --- Authentication & Notification System ---
        
        async function fetchUserFavorites() {
            if (!currentUser) {
                favorites = [];
                return;
            }
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`${SERVER_URL}/api/my-favorites`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    throw new Error('Could not fetch favorites');
                }
                favorites = await response.json();
            } catch (error) {
                console.error('Failed to fetch user favorites:', error);
                favorites = []; 
            }
        }

        // FIXED: Added missing notification functions
        async function fetchNotifications() {
            if (!currentUser) return;
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`${SERVER_URL}/api/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch notifications');
                notificationsCache = await response.json();
                updateNotificationBell();
            } catch (error) {
                console.error('Error fetching notifications:', error);
            }
        }

        function updateNotificationBell() {
            const unreadCount = notificationsCache.filter(n => !n.isRead).length;
            const badge = document.getElementById('notification-badge');
            const mobileBadge = document.getElementById('notification-badge-mobile');
            const bellIcon = document.getElementById('notifications-btn');

            if (badge && mobileBadge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    mobileBadge.textContent = unreadCount;
                    badge.classList.remove('hidden');
                    mobileBadge.classList.remove('hidden');
                    if(bellIcon) bellIcon.classList.add('bell-animation');
                } else {
                    badge.classList.add('hidden');
                    mobileBadge.classList.add('hidden');
                    if(bellIcon) bellIcon.classList.remove('bell-animation');
                }
            }
        }
        
        function initializePushNotifications() {
            console.log("Push notifications would be initialized here.");
        }

        function toggleNotificationsPanel(button) {
            const isMobile = button.id.includes('mobile');
            const panel = isMobile ? document.getElementById('notifications-panel-mobile') : document.getElementById('notifications-panel');
            
            if (!panel) return;

            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                renderNotifications();
                panel.style.display = 'block';
            }
        }

        function renderNotifications() {
            const panel = document.getElementById('notifications-panel');
            const mobilePanel = document.getElementById('notifications-panel-mobile');
            const containerHtml = `<div class="p-2 text-sm text-gray-700 dark:text-gray-300">טוען...</div>`;
            
            if(panel) panel.innerHTML = containerHtml;
            if(mobilePanel) mobilePanel.innerHTML = containerHtml;

            if (notificationsCache.length === 0) {
                const emptyHtml = `<div class="p-4 text-center text-sm text-gray-500 dark:text-gray-400">אין התראות חדשות.</div>`;
                if(panel) panel.innerHTML = emptyHtml;
                if(mobilePanel) mobilePanel.innerHTML = emptyHtml;
                return;
            }

            let notificationsHtml = notificationsCache.map(notif => `
                <a href="${notif.link || '#'}" class="block p-3 hover:bg-gray-100 dark:hover:bg-gray-700 border-b dark:border-gray-600 ${!notif.isRead ? 'font-bold' : ''}">
                    <p class="text-sm">${notif.message}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(notif.createdAt).toLocaleString('he-IL')}</p>
                </a>
            `).join('');

            const fullHtml = `<div class="text-right p-2 border-b dark:border-gray-600"><button id="mark-read-btn" class="text-xs text-teal-500 hover:underline">סמן הכל כנקרא</button></div>${notificationsHtml}`;
            
            if(panel) panel.innerHTML = fullHtml;
            if(mobilePanel) mobilePanel.innerHTML = fullHtml;

            document.querySelectorAll('[id^="mark-read-btn"]').forEach(btn => {
                btn.addEventListener('click', markNotificationsAsRead);
            });
        }

        async function markNotificationsAsRead() {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                await fetch(`${SERVER_URL}/api/notifications/mark-as-read`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                notificationsCache.forEach(n => n.isRead = true);
                updateNotificationBell();
                renderNotifications();
            } catch (error) {
                console.error('Failed to mark notifications as read:', error);
            }
        }
        
        async function checkAuthState() {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');

            if (tokenFromUrl) {
                localStorage.setItem('authToken', tokenFromUrl);
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            const storedToken = localStorage.getItem('authToken');
            
            if (storedToken) {
                const decodedUser = parseJwt(storedToken);
                currentUser = (decodedUser && decodedUser.id) ? decodedUser : null;
                if (!currentUser) localStorage.removeItem('authToken');
            } else {
                currentUser = null;
            }
            
            initializeSocket(storedToken);

            updateUIForAuthState();
            
            if(currentUser) {
                await Promise.all([fetchUserFavorites(), fetchNotifications()]);
                initializePushNotifications(); 
            }
            
            resetAndFetchItems();
            initializeBanners();
        }

        function updateUIForAuthState() {
            const shareButtonHtml = `
                <button id="share-app-btn" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition p-2 rounded-lg" title="שתף את האפליקציה">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
                </button>
            `;
            
            if(headerRightMobile) headerRightMobile.innerHTML = shareButtonHtml;

            if (currentUser) {
                const usernameHtmlDesktop = `<span class="text-sm text-gray-700 dark:text-gray-300 hidden sm:block">שלום, ${currentUser.name}</span>`;
                if(headerRightContent) headerRightContent.innerHTML = shareButtonHtml + usernameHtmlDesktop;

                const actionButtonsHtml = `
                    <div class="relative">
                        <button id="notifications-btn" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 p-2 rounded-full transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                            <span id="notification-badge" class="notification-badge hidden"></span>
                        </button>
                        <div id="notifications-panel" class="bg-white dark:bg-gray-800 rounded-md shadow-lg border dark:border-gray-700">
                        </div>
                    </div>
                    <div class="hidden sm:flex items-center gap-3">
                        <div id="push-notification-container" class="hidden">
                            <button id="push-notification-btn" class="flex items-center gap-2 text-gray-800 font-bold py-2 px-3 rounded-full shadow-md transition transform hover:scale-105" title="טוען סטטוס התראות...">
                            </button>
                        </div>
                        <button id="chat-btn-desktop" class="text-center text-sm bg-cyan-500 text-white py-2 px-4 rounded-md hover:bg-cyan-600 transition whitespace-nowrap">הודעות</button>
                        <button id="profile-btn-desktop" class="text-center text-sm bg-teal-500 text-white py-2 px-4 rounded-md hover:bg-teal-600 transition whitespace-nowrap">הפריטים שלי</button>
                        <button id="logout-btn-desktop" class="text-center text-sm bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition whitespace-nowrap">התנתקות</button>
                    </div>
                `;
                if(authContentDesktop) authContentDesktop.innerHTML = actionButtonsHtml;
                
                const loggedInHtmlMobile = `
                    <div class="flex flex-col items-center gap-2 w-full px-4">
                        <span class="text-sm text-gray-700 dark:text-gray-300 mb-2">שלום, ${currentUser.name}</span>
                        <div id="push-notification-container-mobile" class="w-full mb-2 hidden">
                            <button id="push-notification-btn-mobile" class="w-full flex items-center justify-center gap-2 text-gray-800 font-bold py-2 px-3 rounded-full shadow-md transition transform hover:scale-105" title="טוען סטטוס התראות...">
                            </button>
                        </div>
                        <div class="flex gap-2 w-full">
                            <button id="chat-btn-mobile" class="flex-1 text-sm bg-cyan-500 text-white py-2 px-4 rounded-md hover:bg-cyan-600 transition">הודעות</button>
                            <button id="profile-btn-mobile" class="flex-1 text-sm bg-teal-500 text-white py-2 px-4 rounded-md hover:bg-teal-600 transition">הפריטים שלי</button>
                            <button id="logout-btn-mobile" class="flex-1 text-sm bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition">התנתקות</button>
                        </div>
                    </div>
                `;
                if(authContentMobile) authContentMobile.innerHTML = loggedInHtmlMobile;
                
                const mobileBellHtml = `
                    <div class="relative">
                        <button id="notifications-btn-mobile" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 p-2 rounded-full transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                            <span id="notification-badge-mobile" class="notification-badge hidden"></span>
                        </button>
                        <div id="notifications-panel-mobile" class="bg-white dark:bg-gray-800 rounded-md shadow-lg border dark:border-gray-700">
                        </div>
                    </div>
                `;
                if(headerLeftMobile) headerLeftMobile.innerHTML = mobileBellHtml;

                updateNotificationBell();

            } else {
                if(headerRightContent) headerRightContent.innerHTML = shareButtonHtml;
                if(headerLeftMobile) headerLeftMobile.innerHTML = '';
                const loginButtonHtml = `
                    <div class="hidden sm:flex">
                        <button id="google-login-btn-desktop" class="flex justify-center items-center gap-2 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 text-base border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.618-3.319-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                            <span>התחברות עם Google</span>
                        </button>
                    </div>
                `;
                if(authContentDesktop) authContentDesktop.innerHTML = loginButtonHtml;

                const loggedOutHtmlMobile = `
                     <button id="google-login-btn-mobile" class="w-full flex justify-center items-center gap-2 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 text-base border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.618-3.319-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                        <span>התחברות עם Google</span>
                    </button>
                `;
                if(authContentMobile) authContentMobile.innerHTML = loggedOutHtmlMobile;
            }

            // Re-attach event listeners for all states
            document.querySelectorAll('[id^="google-login-btn"]').forEach(btn => btn.addEventListener('click', handleGoogleLogin));
            document.querySelectorAll('[id^="profile-btn"]').forEach(btn => btn.addEventListener('click', showProfileView));
            document.querySelectorAll('[id^="logout-btn"]').forEach(btn => btn.addEventListener('click', handleLogout));
            document.querySelectorAll('[id^="chat-btn"]').forEach(btn => btn.addEventListener('click', () => showChatView()));
            document.querySelectorAll('[id^="share-app-btn"]').forEach(btn => btn.addEventListener('click', shareApp));
            
            document.querySelectorAll('[id^="notifications-btn"]').forEach(btn => {
                btn.addEventListener('click', (e) => toggleNotificationsPanel(e.currentTarget));
            });
        }
        
        function handleGoogleLogin() { window.location.href = `${SERVER_URL}/auth/google`; }
        function handleLogout() { 
            localStorage.removeItem('authToken'); 
            currentUser = null; 
            initializeSocket(null);
            showView('main-view'); 
            updateUIForAuthState(); 
            resetAndFetchItems(); 
        }
        
        // --- Init ---
        checkAuthState();

    });
    </script>
</body>
</html>
